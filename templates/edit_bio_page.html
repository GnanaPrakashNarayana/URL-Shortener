<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Bio Page - {{ .BioPage.Title }}</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <meta name="theme-color" content="#0071e3">
</head>
<body>
    <header class="site-header">
        <div class="site-header-inner">
            <a href="/" class="site-logo fade-in">Rapid URL</a>
            <nav class="site-nav fade-in delay-1">
                <span>Welcome, {{ .User.Username }}</span>
                <a href="/bio/pages" class="btn btn-secondary">My Bio Pages</a>
                <a href="/dashboard" class="btn btn-secondary">Dashboard</a>
                <a href="/auth/logout" class="btn btn-link">Logout</a>
            </nav>
        </div>
    </header>

    <div class="dashboard-container">
        <div class="dashboard-header fade-in">
            <h1>Edit Bio Page</h1>
            <div class="dashboard-nav">
                <a href="{{ .BioPage.ShortURL }}" target="_blank" class="btn btn-primary">View Page</a>
                <a href="/bio/pages" class="btn btn-secondary">Back to List</a>
            </div>
        </div>

        {{ if .Error }}
        <div class="error fade-in delay-1">
            {{ .Error }}
        </div>
        {{ end }}

        {{ if .Success }}
        <div class="success-message fade-in delay-1">
            {{ .Success }}
        </div>
        {{ end }}

        <!-- Page Info Section -->
        <div class="bio-page-info fade-in delay-2">
            <div class="card">
                <div class="card-body">
                    <div class="bio-page-url">
                        <div class="url-label">Bio Page URL:</div>
                        <div class="url-value">
                            <a href="{{ .BioPage.ShortURL }}" target="_blank" class="url-link">{{ .BioPage.ShortURL }}</a>
                            <button class="copy-btn" data-url="{{ .BioPage.ShortURL }}">Copy</button>
                            <button class="qr-code-btn" data-url="{{ .BioPage.ShortURL }}">QR</button>
                        </div>
                    </div>
                    <div class="bio-page-stats">
                        <div class="stat">
                            <div class="stat-value">{{ .BioPage.Visits }}</div>
                            <div class="stat-label">Page Views</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">{{ len .BioPage.Links }}</div>
                            <div class="stat-label">Links</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs for settings and links -->
        <div class="bio-page-tabs fade-in delay-3">
            <div class="tabs">
                <button class="tab-button active" data-tab="settings">Settings</button>
                <button class="tab-button" data-tab="links">Links</button>
                <button class="tab-button" data-tab="appearance">Appearance</button>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings" class="tab-content active">
                <form action="/bio/update/{{ .BioPage.ID }}" method="post" class="card">
                    <div class="card-body">
                        <input type="hidden" name="gorilla.csrf.Token" value="{{ .CSRFToken }}">

                        <div class="form-group">
                            <label for="title" class="form-label">Page Title</label>
                            <input type="text" id="title" name="title" class="form-control" required value="{{ .BioPage.Title }}">
                        </div>

                        <div class="form-group">
                            <label for="description" class="form-label">Description</label>
                            <textarea id="description" name="description" class="form-control" rows="3">{{ .BioPage.Description }}</textarea>
                        </div>

                        <div class="form-group">
                            <label for="profile_image_url" class="form-label">Profile Image URL (Optional)</label>
                            <input type="url" id="profile_image_url" name="profile_image_url" class="form-control" value="{{ .BioPage.ProfileImageURL }}">
                            <p class="input-hint">Enter a URL to an image (e.g., from your website or image hosting)</p>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="is_published" name="is_published" {{ if .BioPage.IsPublished }}checked{{ end }}>
                                <label for="is_published" class="checkbox-label">Publish Page</label>
                            </div>
                            <p class="input-hint">When published, your bio page will be visible to anyone with the link</p>
                        </div>

                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
            
            <!-- Links Tab -->
            <div id="links" class="tab-content">
                <div class="card">
                    <div class="card-body">
                        <h3>Add New Link</h3>
                        <form action="/bio/links/add/{{ .BioPage.ID }}" method="post" class="add-link-form">
                            <input type="hidden" name="gorilla.csrf.Token" value="{{ .CSRFToken }}">
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="link_title" class="form-label">Link Title</label>
                                    <input type="text" id="link_title" name="title" class="form-control" required placeholder="My Website">
                                </div>
                                
                                <div class="form-group">
                                    <label for="link_url" class="form-label">URL</label>
                                    <input type="url" id="link_url" name="url" class="form-control" required placeholder="https://example.com">
                                </div>
                                
                                <div class="form-submit">
                                    <button type="submit" class="btn btn-primary">Add Link</button>
                                </div>
                            </div>
                        </form>
                        
                        <div class="links-divider"></div>
                        
                        <h3>Your Links</h3>
                        <div class="bio-links-list" id="bio-links-container">
                            {{ if .BioPage.Links }}
                                {{ range .BioPage.Links }}
                                <div class="bio-link-item" data-id="{{ .ID }}">
                                    <div class="drag-handle">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                                    </div>
                                    <div class="bio-link-content">
                                        <div class="bio-link-title">{{ .Title }}</div>
                                        <div class="bio-link-url">{{ .URL }}</div>
                                    </div>
                                    <div class="bio-link-visits" title="Link visits">{{ .Visits }}</div>
                                    <div class="bio-link-actions">
                                        <form action="/bio/links/update/{{ .ID }}" method="post" class="update-link-form">
                                            <input type="hidden" name="gorilla.csrf.Token" value="{{ $.CSRFToken }}">
                                            <input type="hidden" name="title" value="{{ .Title }}">
                                            <input type="hidden" name="url" value="{{ .URL }}">
                                            <input type="hidden" name="is_enabled" value="{{ if .IsEnabled }}true{{ else }}false{{ end }}">
                                            
                                            <button type="button" class="btn-edit" onclick="editBioLink(this)">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                            </button>
                                            
                                            <button type="button" class="btn-toggle {{ if .IsEnabled }}enabled{{ else }}disabled{{ end }}" onclick="toggleLinkEnabled(this)">
                                                {{ if .IsEnabled }}
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                                {{ else }}
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                                                {{ end }}
                                            </button>
                                            
                                            <a href="/bio/links/delete/{{ .ID }}" class="btn-delete" onclick="return confirm('Are you sure you want to delete this link?')">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                            </a>
                                        </form>
                                    </div>
                                </div>
                                {{ end }}
                            {{ else }}
                                <div class="no-links-message">
                                    <p>You haven't added any links yet. Add your first link above!</p>
                                </div>
                            {{ end }}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Appearance Tab -->
            <div id="appearance" class="tab-content">
                <div class="card">
                    <div class="card-body">
                        <form action="/bio/update/{{ .BioPage.ID }}" method="post">
                            <input type="hidden" name="gorilla.csrf.Token" value="{{ .CSRFToken }}">
                            <input type="hidden" name="title" value="{{ .BioPage.Title }}">
                            <input type="hidden" name="description" value="{{ .BioPage.Description }}">
                            <input type="hidden" name="profile_image_url" value="{{ .BioPage.ProfileImageURL }}">
                            <input type="hidden" name="is_published" value="{{ if .BioPage.IsPublished }}on{{ end }}">
                            
                            <div class="form-group">
                                <label for="theme" class="form-label">Theme</label>
                                <select id="theme" name="theme" class="form-control">
                                    {{ range .Themes }}
                                    <option value="{{ . }}" {{ if eq . $.BioPage.Theme }}selected{{ end }}>{{ . | title }}</option>
                                    {{ end }}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="custom_css" class="form-label">Custom CSS (Advanced)</label>
                                <textarea id="custom_css" name="custom_css" class="form-control code-editor" rows="10">{{ .BioPage.CustomCSS }}</textarea>
                                <p class="input-hint">Add custom CSS to personalize your bio page</p>
                            </div>
                            
                            <div class="theme-preview">
                                <h4>Theme Preview</h4>
                                <div class="preview-container" id="theme-preview">
                                    <!-- Preview content will be generated by JavaScript -->
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Save Appearance</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Link Edit Modal - Hidden by default -->
        <div id="edit-link-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-modal" onclick="closeEditModal()">&times;</span>
                <h3>Edit Link</h3>
                <form id="edit-link-form" method="post">
                    <input type="hidden" name="gorilla.csrf.Token" value="{{ .CSRFToken }}">
                    
                    <div class="form-group">
                        <label for="edit_title" class="form-label">Link Title</label>
                        <input type="text" id="edit_title" name="title" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_url" class="form-label">URL</label>
                        <input type="url" id="edit_url" name="url" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="edit_is_enabled" name="is_enabled">
                            <label for="edit_is_enabled" class="checkbox-label">Enable Link</label>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="/static/js/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tab functionality
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Hide all tab contents
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Remove active class from all buttons
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Show the selected tab content
                    document.getElementById(tabId).classList.add('active');
                    
                    // Add active class to the clicked button
                    this.classList.add('active');
                });
            });
            
            // Make links sortable
            const container = document.getElementById('bio-links-container');
            if (container) {
                const sortable = new Sortable(container, {
                    animation: 150,
                    handle: '.drag-handle',
                    onEnd: function() {
                        // Get the new order
                        const linkItems = container.querySelectorAll('.bio-link-item');
                        const linkIds = Array.from(linkItems).map(item => item.getAttribute('data-id'));
                        
                        // Send the new order to the server
                        fetch('/bio/links/reorder/{{ .BioPage.ID }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': '{{ .CSRFToken }}'
                            },
                            body: JSON.stringify({ link_ids: linkIds })
                        })
                        .then(response => {
                            if (!response.ok) {
                                console.error('Failed to reorder links');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                    }
                });
            }
            
            // Theme preview functionality
            updateThemePreview();
            document.getElementById('theme').addEventListener('change', updateThemePreview);
            document.getElementById('custom_css').addEventListener('input', updateThemePreview);
        });
        
        function updateThemePreview() {
            const theme = document.getElementById('theme').value;
            const customCSS = document.getElementById('custom_css').value;
            const previewContainer = document.getElementById('theme-preview');
            
            // Generate preview HTML
            const previewHTML = `
                <div class="bio-preview-page theme-${theme}">
                    <div class="bio-preview-header">
                        <div class="bio-preview-avatar"></div>
                        <div class="bio-preview-title">Page Title</div>
                        <div class="bio-preview-description">This is a sample description</div>
                    </div>
                    <div class="bio-preview-links">
                        <div class="bio-preview-link">Link 1</div>
                        <div class="bio-preview-link">Link 2</div>
                        <div class="bio-preview-link">Link 3</div>
                    </div>
                </div>
                <style>
                    ${customCSS}
                </style>
            `;
            
            previewContainer.innerHTML = previewHTML;
        }
        
        // Link editing functionality
        function editBioLink(button) {
            const form = button.closest('form');
            const titleInput = form.querySelector('input[name="title"]');
            const urlInput = form.querySelector('input[name="url"]');
            const isEnabledInput = form.querySelector('input[name="is_enabled"]');
            
            // Set the form action
            const editForm = document.getElementById('edit-link-form');
            editForm.action = form.action;
            
            // Set the form values
            document.getElementById('edit_title').value = titleInput.value;
            document.getElementById('edit_url').value = urlInput.value;
            document.getElementById('edit_is_enabled').checked = isEnabledInput.value === 'true';
            
            // Show the modal
            document.getElementById('edit-link-modal').style.display = 'block';
        }
        
        function closeEditModal() {
            document.getElementById('edit-link-modal').style.display = 'none';
        }
        
        function toggleLinkEnabled(button) {
            const form = button.closest('form');
            const isEnabledInput = form.querySelector('input[name="is_enabled"]');
            
            // Toggle the value
            isEnabledInput.value = isEnabledInput.value === 'true' ? 'false' : 'true';
            
            // Submit the form
            form.submit();
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('edit-link-modal');
            if (event.target === modal) {
                closeEditModal();
            }
        };
    </script>
</body>
</html>